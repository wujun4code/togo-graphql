
model User {
  id                Int                 @id @default(autoincrement())
  email             String              @unique
  username          String              @unique
  friendlyName      String?
  
  snsName           String              @unique @default(cuid())

  posts             Post[]
  travelPlans       TravelPlan[]
  roles             RoleUser[]

  followers         Follow[] @relation(name: "Followers")
  followees         Follow[] @relation(name: "Followees")

  oauth2Bindings    User_OAuth2[] @relation(name: "OAuth2_Binding")

  createdAt         DateTime @unique() @default(now()) @db.Timestamptz(3)
  updatedAt         DateTime @unique() @default(now()) @updatedAt @db.Timestamptz(3)
}

model OAuth2 {
  id                Int                 @id @default(autoincrement())
  
  provider          String              
  clientId          String              

  authUsers            User_OAuth2[]       @relation(name: "OAuth2_Providers")

  @@unique([provider, clientId], name: "unique_provider_clientId")
}

model User_OAuth2 {
  id                Int                 @id @default(autoincrement())

  oauth2Id          Int
  oauth2            OAuth2              @relation(name: "OAuth2_Providers", fields: [oauth2Id], references: [id])

  userId            Int
  user              User                @relation(name: "OAuth2_Binding", fields: [userId], references: [id])

  openId            String

  createdAt         DateTime @unique() @default(now()) @db.Timestamptz(3)
  updatedAt         DateTime @unique() @default(now()) @updatedAt @db.Timestamptz(3)

  @@unique([oauth2Id, userId, openId], name: "unique_provider_userId_clientId")
}

model Role {
  id                Int                 @id @default(autoincrement())
  name              String              @unique
  description       String
  users             RoleUser[]
}

model RoleUser {
  id     Int  @id @default(autoincrement())
  roleId Int
  userId Int
  user   User @relation(fields: [userId], references: [id])
  role   Role @relation(fields: [roleId], references: [id])
  
  createdAt         DateTime @unique() @default(now()) @db.Timestamptz(3)
  updatedAt         DateTime @unique() @default(now()) @updatedAt @db.Timestamptz(3)

  @@index([roleId, userId], name: "unique_user_role")
}
